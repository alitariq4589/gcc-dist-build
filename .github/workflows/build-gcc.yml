name: Build GCC for RISC-V

on:
    push:
    workflow_dispatch:

jobs:
  build:
    runs-on: RISCV64
    permissions:
      contents: write
    outputs:
      tag_name: ${{ steps.get-latest-tag.outputs.tag_name }}
      release_name: ${{ steps.get-version.outputs.release_name }}
      asset_name: ${{ steps.get-version.outputs.asset_name }}
      asset_path: ${{ steps.get-version.outputs.asset_path }}

    steps:
      - name: Install dependencies
        run: |
         sudo apt-get update
         sudo apt-get install -y \
           build-essential \
           libatomic1 \
           flex \
           bison \
           distcc

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Directories
        run: mkdir -p $GITHUB_WORKSPACE/installed_binaries

      - name: Setup distributed compilation
        run: |
          # Configure distcc cluster
          export DISTCC_HOSTS="${{ secrets.DISTCC_HOSTS }}"
          echo "DISTCC_HOSTS=$DISTCC_HOSTS" >> $GITHUB_ENV
          
          # Calculate total parallel jobs
          # Format: 2 visionfive2 (4 cores each) + 3 visionfive1 (2 cores each) = 14 cores
          # Use 1.5x multiplier for optimal throughput
          TOTAL_JOBS=20
          echo "TOTAL_JOBS=$TOTAL_JOBS" >> $GITHUB_ENV
          
          # Enable distcc logging for debugging
          export DISTCC_VERBOSE=1
          export DISTCC_LOG=/tmp/distcc.log
          echo "DISTCC_VERBOSE=1" >> $GITHUB_ENV
          echo "DISTCC_LOG=/tmp/distcc.log" >> $GITHUB_ENV
          
          # Test connectivity
          echo "Testing distcc connectivity..."
          for host in $(echo "$DISTCC_HOSTS" | tr ' ' '\n' | cut -d/ -f1 | grep -v localhost); do
            if timeout 5 bash -c "</dev/tcp/$host/3632" 2>/dev/null; then
              echo "âœ“ $host is reachable"
            else
              echo "âš  Warning: $host is not reachable"
            fi
          done
      
      - name: Check environment
        run: |
          set -eux
          uname -a
          gcc --version
          g++ --version
          ldd --version
          distcc --version
          echo "DISTCC_HOSTS=$DISTCC_HOSTS"
          echo "Total parallel jobs: $TOTAL_JOBS"

      - name: Clone GCC and checkout latest tag
        id: get-latest-tag
        run: |
          set -eux

          # Tweak Git to be more resilient on CI
          git config --global http.postBuffer 524288000
          git config --global http.maxRequests 2
          git config --global core.compression 0

          rm -rf gcc installed_binaries
          git clone --depth=1 --no-tags git://gcc.gnu.org/git/gcc.git
          cd gcc

          # Fetch only tag references (without full history)
          git fetch --tags --depth=1

          LATEST_TAG=$(git tag -l "releases/gcc*" | sort -V | tail -n 1)
          echo "Checking out $LATEST_TAG"

          # Fetch and checkout just that tag commit (still shallow)
          git fetch --depth=1 origin tag $LATEST_TAG
          git checkout FETCH_HEAD

          echo "tag_name=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Get Prerequisites
        run: |
          mkdir -p installed_binaries
          cd gcc
          ./contrib/download_prerequisites
      
      - name: Configure
        run: |
          cd gcc
          mkdir build
          cd build
          
          # CRITICAL: Configure with distcc as the compiler
          # Don't use ccache, just distcc directly
          ../configure \
            --prefix=$GITHUB_WORKSPACE/installed_binaries \
            --disable-werror \
            --disable-multilib \
            --enable-languages=c,c++ \
            # --disable-bootstrap

      - name: Build GCC with distributed compilation
        run: |
          cd gcc/build

          # Start monitoring in background
          if command -v distccmon-text &> /dev/null; then
            (
              while true; do
                echo "=== Compilation status at $(date '+%H:%M:%S') ==="
                distccmon-text | head -20
                echo ""
                sleep 30
              done
            ) &
            MONITOR_PID=$!
            trap "kill $MONITOR_PID 2>/dev/null || true" EXIT
          fi

          # Build with distributed compilation
          # Use distcc during make, not configure
          echo "Starting distributed build with -j$TOTAL_JOBS"
          time make -j$TOTAL_JOBS CC="distcc gcc" CXX="distcc g++"

          # Show distcc log summary
          echo "=== distcc log summary ==="
          if [ -f /tmp/distcc.log ]; then
            echo "Total compilations:"
            grep -c "compile" /tmp/distcc.log || echo "0"
            echo ""
            echo "Remote compilations:"
            grep -c "remote" /tmp/distcc.log || echo "0"
            echo ""
            echo "Last 20 log lines:"
            tail -20 /tmp/distcc.log
          fi

          # Kill monitor if running
          kill $MONITOR_PID 2>/dev/null || true

      - name: Install
        run: |
          cd gcc/build
          make install

      - name: Verify installation
        run: |
          cd $GITHUB_WORKSPACE/installed_binaries
          ./bin/gcc --version
          ./bin/g++ --version

      - name: Get GCC version and set outputs
        id: get-version
        run: |
          GCC_VERSION=$($GITHUB_WORKSPACE/installed_binaries/bin/gcc -dumpfullversion -dumpversion)
          ASSET_NAME="gcc-${GCC_VERSION}-riscv64-linux.tar.gz"
          ASSET_PATH="$GITHUB_WORKSPACE/${ASSET_NAME}"

          echo "release_name=GCC ${GCC_VERSION} RISC-V" >> $GITHUB_OUTPUT
          echo "asset_name=$ASSET_NAME" >> $GITHUB_OUTPUT
          echo "asset_path=$ASSET_PATH" >> $GITHUB_OUTPUT

      - name: Package binaries
        run: |
          tar -czf ${{ steps.get-version.outputs.asset_path }} -C ${{ github.workspace }}/installed_binaries .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get-version.outputs.asset_name }}
          path: ${{ steps.get-version.outputs.asset_path }}

      - name: Create or push to tag
        run: |
          TAG=${{ steps.get-latest-tag.outputs.tag_name }}

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "âœ… Tag $TAG already exists. Skipping tag creation." 
          else
            echo "ðŸ†• Tag $TAG does not exist. Creating and pushing..."
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get-latest-tag.outputs.tag_name }}
          files: ${{ steps.get-version.outputs.asset_path }}

    #   - name: Get GCC version and set outputs
    #     id: get-version
    #     run: |
    #       GCC_VERSION=$($GITHUB_WORKSPACE/installed_binaries/bin/gcc -dumpfullversion -dumpversion)
    #       ASSET_NAME="gcc-${GCC_VERSION}-riscv64-linux.tar.gz"
    #       ASSET_PATH="$GITHUB_WORKSPACE/${ASSET_NAME}"

    #       echo "release_name=GCC ${GCC_VERSION} RISC-V" >> $GITHUB_OUTPUT
    #       echo "asset_name=$ASSET_NAME" >> $GITHUB_OUTPUT
    #       echo "asset_path=$ASSET_PATH" >> $GITHUB_OUTPUT

    #   - name: Package binaries
    #     run: |
    #       tar -czf ${{ steps.get-version.outputs.asset_path }} -C ${{ github.workspace }}/installed_binaries .

    #   - name: Upload artifact
    #     uses: actions/upload-artifact@v4
    #     with:
    #       name: ${{ steps.get-version.outputs.asset_name }}
    #       path: ${{ steps.get-version.outputs.asset_path }}

    #   - name: Create or push to tag
    #     run: |
    #       TAG=${{ steps.get-latest-tag.outputs.tag_name }}

    #       git config user.name "github-actions[bot]"
    #       git config user.email "github-actions[bot]@users.noreply.github.com"

    #       if git ls-remote --exit-code --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
    #         echo "âœ… Tag $TAG already exists. Skipping tag creation." 
    #       else
    #         echo "ðŸ†• Tag $TAG does not exist. Creating and pushing..."
    #         git tag "$TAG"
    #         git push origin "$TAG"
    #       fi

    #   - name: Release
    #     uses: softprops/action-gh-release@v2
    #     with:
    #       tag_name: ${{ steps.get-latest-tag.outputs.tag_name }}
    #       files: ${{ steps.get-version.outputs.asset_path }}